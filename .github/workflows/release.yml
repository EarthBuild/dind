name: Release

on:
  pull_request:
    branches: ["main"]
  # pull_request_target:
  #   types: [ closed ]

jobs:
  release:
    name: release after merging ${{ github.head_ref }}
    # if: github.event.pull_request.merged == true && startsWith(github.head_ref, 'renovate/') && endsWith(github.head_ref, '-dind-image')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      FORCE_COLOR: 1
      EARTHLY_CONVERSION_PARALLELISM: "5"
      EARTHLY_INSTALL_ID: "earthbuild-dind-githubactions"
    steps:
      - uses: earthbuild/actions-setup@main
        with:
          version: v0.8.15
      - uses: actions/checkout@v4
      - name: Set up Docker Hub mirrors
        run: |
          sudo mkdir -p /etc/docker
          echo '{"registry-mirrors": ["https://mirror.gcr.io", "https://public.ecr.aws"]}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
      - name: Log in to container registries (non fork only)
        run: |-
          docker login --username "${{ secrets.DOCKERHUB_USERNAME }}" --password "${{ secrets.DOCKERHUB_TOKEN }}"
          docker login ghcr.io --username ${{ github.actor }} --password "${{ secrets.GITHUB_TOKEN }}"
        if: github.event.pull_request.head.repo.full_name == github.repository
      - name: Build & Push image
        run: |
          earthly --ci -P +release --RENOVATE_BRANCH=renovate/major-28-ubuntu-23.04-dind-image # default:ghcr.io
          earthly --ci -P +release --RENOVATE_BRANCH=renovate/major-28-ubuntu-23.04-dind-image --CR_HOST=docker.io
